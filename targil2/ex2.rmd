---
title: "targil2"
author: '20474862'
date: "1 αιεπι 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(gdata)
library(ggpmisc)
library(gganimate)
library(maps)
library(ggthemes)
library("usmap")
library(dplyr)
library(plotly)
library(tidyr)

```

###Measles Vaccines
In this exercise, we want to use R and our statistics theory knowladge to try and understand the benefits and effects of vaccines.

###Part I
First, we would like to load our data. The data used for these plots were collected, organized and distributed by the Tycho Project. They include weekly reported counts data for seven diseases from 1928 to 2011, from all fifty states.

To do so, we'll define our work directory with the command workdir, and afterwards we can load the data by using the read.csv command.

```{r}
#define the workdir
workdir = "C:/Users/Liav/Desktop/Uni/R/targil2"
setwd(workdir)
#loading the data
data = read.csv("diseases.csv")
```

1. In the following part we will try to focus on the measles disease. Measles affects about 20 million people a year,primarily in the developing areas of Africa and Asia. It is one of the leading vaccine-preventable disease causes of death..

Let's start cleaning our data. First, we can remove the rows of Alaska and Hawaii from the data (since they only became states in the late 50s).
Since our different observations collected over various amount of weeks every year, we can cancel this effect by creating an "estimated yearly" value by taking the weekly average, and multiply by 52 (the number of weeks in a year). Moreover, in order to eliminate the effect of the population in each state , and create diseases_rate column, which is the disease apperance per 100K people.
```{r}
#removing Alaska and Hawaii
data = data[-c(which(data$state %in% c("Hawaii","Alaska") )),]
#add estimated yearly
data$disease_rate = ((data$count/data$weeks_reporting)*52)/(data$population/100000)
#clean the null values
data = na.omit(data)
#peek the top of our data
head(data)
```

Now, since we would like to focus on the Measles disease, we will filter our data frame rows which their "disease" value is "Measles".
```{r}
#save subset of Measles out of our data.
dat = data[which(data$disease=="Measles"),]
```


2. To test the effects of the measles vaccine, we can look at the state of California as a case study.
Let's draw a plot of the measles cases over the years. We can add a vertical line where the year was 1963, when John Enders and colleagues transformed their Edmonston-B strain of measles virus into a vaccine and licensed it in the United States. To draw the plot, we can use the ggplot2 library.
```{r, warning=FALSE}
#creating the california subset dataframe
cali = dat[which(dat$state == "California"),]
#create a line plot
cali_time_plot = ggplot(cali, aes(x=year, y=disease_rate)) + geom_line(color="tomato2", size = 1)
#add x,y lables
cali_time_plot = cali_time_plot + ylab("California measles rate per 100K people") + xlab("Year") 
#add the 1963 vertical line and add a label on it
cali_time_plot = cali_time_plot + geom_vline(size = 1, xintercept = 1963.5, linetype="dotted") + annotate("text", x = 1963, y = 800, angle = 90, label = "1963: Measles vaccine invented",vjust = 0) + theme(axis.title=element_text(size=13))
#just a designing line
cali_time_plot = cali_time_plot +  geom_point(shape = ".")
#show the plot
cali_time_plot + ggtitle("California's Measles rate over history")


```

It is easy to notice that since 1963 (When they began to vaccine) there is a sharp and consistent decrease in the trend of measles cases. In addition, we can notice that in 1942 we had a lot of Measles cases around california. We can develop some theories about this fact, but for now, let's label that bar and continue with our analysis.


3. Now, to check if this pattern holds for the other states, we can use boxplots to get an idea of the distribution of rates for each year. 
To do so, we will use again the ggplot library, this time with the geom_boxplot function.

```{r}
#create the box plot
national_rate = ggplot(data = dat, aes(x=year, y=disease_rate, group=year)) + geom_boxplot()
#add lables for x,y
national_rate = national_rate + ylab("National measles cases per 100K people") + xlab("Year") 
#show the plot with it's title
national_rate + ggtitle("National Measles rate over the history")

```



Again, It is not difficult to see that If we look at the phenomenon in national dimensions, since the Measles vaccine liscensed, the Measles rate aims to none.

Since we can barely see the differences on the last years, i thought it will be a good idea to choose a different scale for y.
In the graph below we can see that even in the years that the Measles apperance was almost none, there is still a downward trend.
```{r, warning=FALSE}

#show the plot with different y scale
national_rate + scale_y_continuous(trans = "log10")  + ylab("National measles cases per 100K people log scale") + ggtitle("National Measles rate over the different states in the US, log scaled")

```

4. One problem with the boxplot is that it does not let us see state-specific trends. To overcome this problem, we can plot the Measles disease rates per year for all states, in a similar method to the state of California graph. We can also calculate the yearly average mealses rate for every year, and add it to our plot in black.

```{r, warning=FALSE}
#groupby the years by average to a new dataframe
yearly_average_data = dat %>% group_by(year) %>%  summarise_all(funs (mean = mean(., na.rm = TRUE)))
#create the ggplot line
national_rate_line = ggplot() + geom_line(data = dat, aes(x=year, y=disease_rate, group=state),col="orangered3",alpha=0.2)
#add lables to the graph
national_rate_line = national_rate_line + ylab("US measles yearly rate per 100K") + xlab("Year") 
#add the vertical line
national_rate_line= national_rate_line + geom_vline(size = 1, xintercept = 1963, linetype="dotted") + annotate("text", x = 1962.5, y = 2500, angle = 90, label = "1963",vjust = 0)
#add the average yearly rate line with a black color  
national_rate_line = national_rate_line + geom_line(data = yearly_average_data, aes(x = year , y = disease_rate_mean),color="black", size=1.5)
#put the legend on bottom
national_rate_line = national_rate_line + theme(legend.position = "bottom")
#show the plot
national_rate_line + ggtitle("National Measles rate over the different states in the US")
```


We can see that there is a lot of mess when we look at all the states. Therefor, i chose to bold the national average line, and use "alpha" to make the lines a bit transparent, so the darker line parts are those with more lines.

We can see that after 1963 the rate in all the states is going down to none.

This graph is still not perfect. We can not really see which state has whice Measles rate. Therefor, we can use gganimate and ggplot to create a nice animation that shows the rate change over the years.  
```{R}
#create the point plot of the graph
animated_measles_rate = ggplot(data=dat, aes(x=state, y = disease_rate, colour = state)) + geom_point(show.legend = FALSE, alpha=0.7) + scale_color_viridis_d()
#use time transition and set axis lables
animated_measles_rate = animated_measles_rate + transition_time(year) + labs(title = "Year: {frame_time}", x="State",y="Measles Rate") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + theme(axis.title = element_text(size = 20), plot.title = element_text(size = 30))
#run the animation with 6 frames per second
animate(animated_measles_rate, fps=6)
```


Here it is really nice to see that after 1963 the rate in all states is going down to none ! 
We can also notich which states are the ones the make the little rate jump in 1997.

We can see that in both graph we showed, and similar to California's measles apperance trend, the USA trend convergent to 0 since the vaccine liscensed in the United States.


###Part II

5. Now, we would like to compare the rates of different diseases across years in California.
To do so, we first need to get California's dataset for all the different diseases.
```{r}

#creating the california subset dataframe
cali_diseases = data[which(data$state == "California"),]
#a sample of the graph
head(cali_diseases)
```

And use the very same methods we used for the different states, to draw the different diseases graphs.
(Take a note that we can use sqrt on y axis so we can look at the difference better)
```{r}
cali_diseases_line = ggplot(cali_diseases, aes(x=year, y=disease_rate, colour=disease)) + geom_line()
#add lables to the graph

cali_diseases_line = cali_diseases_line + ylab("California yearly disease rate per 100K") + xlab("Year")  + scale_y_sqrt()
#move the legend to the bottom
cali_diseases_line = cali_diseases_line + theme(legend.position = "bottom")


#show the plot with it's title
cali_diseases_line + ggtitle("Disease apperance in California over history")
```

6. Now, another interesting question is what happend to different diseases rate over time. Lets draw a scatter plot comparing the rates of two diseases in California. For the following comparison, i chose Mumps and Hepatitis A, since the observation of those diseases were collected around same period, but their vaccines were licensed in different decades.
To do so, we can create two different dataframes that represents each of these diseases rate over the years, and join them. Afterwards, we will create a scatter plot of the rate in each year, while one rate is on the x scale, and the other is on the y scale.
Finally, since the dots are close to each other, and since we want to have an indication to the year value, we can color the dots by their year value will go from darker to lighter color.
```{r}
#create a Mumps rate dataframe
cali_mumps_rate = cali_diseases[which(cali_diseases$disease == "Mumps" ),]
#create a cali rate dataframe
cali_hepatitis_rate = cali_diseases[which(cali_diseases$disease == "Hepatitis A" ),]
# x is mumps and y is hepatitis, now we can select the columns we want
cali_joined_rate = inner_join(cali_mumps_rate,cali_hepatitis_rate, by = c("year"="year")) %>% select(year, disease_rate.x, disease_rate.y)
#give the columns informative names
colnames(cali_joined_rate) = c("year", "Mumps_rate", "Hepatitis_rate")
#define our plot with the color scale
cali_mumps_hep_plot = ggplot(cali_joined_rate,aes(x = cali_joined_rate$`Mumps_rate`, y = cali_joined_rate$`Hepatitis_rate` ,color = year)) + geom_point(size=3)
#add x,y lables
cali_mumps_hep_plot = cali_mumps_hep_plot + ylab("Hepatitis rate") + xlab("Mumps rate") 
#show the plot with it's title
cali_mumps_hep_plot + ggtitle("Mumps and Hepatitis A rate in California over history")

```

Again, we can tell by this graph that the rate of both diseases is getting lower over time. Since the Mumps vaccine was licensed in the early 70's, and Hepatitis A vaccine licensed in the middle of the 90's, i would say that there is a causation between the invention of their vaccine and their downward trend over the years.

####A Brief Summary
7. At first, we have seen a causation between the US Measles rate over the years and the invention of the Measles vaccince. We used California as a study case, and later on we noticed that the rate is similar all over the United States. Finally, we took example of two different diseases rates in California and we could easily say that both of their rates decreased over time, while Mumps rate started decrease around the 70's and Hepatitis A rate started decreasing around the 90's in accordance with the registration period for vaccinations.
I think that the conclusion is that the vaccination is needed for the society, and really is life saving.


###Part III
8. Here well start analyzing the results we collected in class regarding the display of visual information.
First, we will load the Clevelad Experiment data and Recode the column names so that you have a variable for experiment type and a variable for experiment number (this will help us next)

```{r}
#load the cleveland data
cleveland = read.csv("Cleveland_Experiment-2.csv")
#load the correct data
load("correct_2019.rda")
#remove the NULL column
cleveland = cleveland[,(2:length(cleveland))]
```

Let's take a look on our original names, and check what is the change we can do.
```{r}
head(cleveland)
```
We can see that in column Question 3.3 the values are factors and not numeric. but why ?
Apparently, we need to fix a little bug in our data. Someone accidently added a non integer sign. let's fix it.
```{r}
#turn each column to characters column
cleveland = data.frame(lapply(cleveland, as.character), stringsAsFactors=FALSE)
#remove the bad string
for (i in 1:nrow(cleveland)) {
  cleveland[i,]=gsub("[^0-9.-]", "", cleveland[i,])
}
cleveland = data.frame(lapply(cleveland, as.numeric), stringsAsFactors=FALSE)
```


We can see that the columns names are patteren as Question.Question_number.Experiment number, while there are 4 experiments labeld from 0 to 3. To give better names, we can use the "paste" function in a double four loop and create a better name vector.
```{r}
#create a names vector
names = c()
#create temporary questions vector
temp = c()
#for loop over the experiments number
for(e in 1:4){
  #create an experiment number string
  experiment_str = ""
  if (e==1){
    experiment_str = "Pie"
  }
    if (e==2){
    experiment_str = "Line"
    }
    if (e==3){
    experiment_str = "Shade"
    }
    if (e==4){
    experiment_str = "Spot"
  }
   for (q in 1:5){
     #add all the experiment's question numbers
    temp = append(temp, paste(experiment_str,"ques",q))
   }
  #at the end of the inner loop, add the experiment to the names vector
    names = append(names, temp)
    #restart the question number vector
    temp = c()
}
#attach cleveleand new names
colnames(cleveland) = names
#check
head(cleveland)
```
So now it is easier to see which question belong to which experiment.

9. Now, we want the the a look at the distribution of guesses of Question 2 of the experiment. To do so, we can draw a histogram, or draw a qq plot. Let's make both.
a. First, We can start with the comparison of the histogram and the normal curve.
```{r}
ques2 = cleveland$`Pie ques 2`

#create the histogram
hist(ques2,  freq=FALSE, breaks = 30, main = "Histogram and Normal Distribution" ,xlim = c(0,100), xlab = "Pie ques. 2", col = "orangered3" )
#create the normal curve
curve(dnorm(x, mean=mean(ques2), sd=sd(ques2)), col="darkblue", lwd=2, add=TRUE, lty=5)
#add legend
legend("topright" ,c("Normal Density"), col =c("darkblue"), lty = c(2,NA), pch =c(NA,15), bty = "n" )

```

We can see that the distibution is not that Normal. Further more, we can see that we have an outlier with the value 90.

Now let's check the qqplot:
```{r}
#create the ggplot
qqplot_ques2 = ggplot(cleveland, aes(sample = cleveland$`Pie ques 2`))
#add titles of axis and plot
qqplot_ques2 = qqplot_ques2 + ggtitle("QQ-PLOT for the Pie Question 2 distribution") + xlab("quantile") + ylab("quantile")
#draw qqline and qq stats
qqplot_ques2 + stat_qq() + stat_qq_line()
```

We can see clearly that our data have a right and left tale, that matches the outlier.

b. Another comparison we can make is of the normal distribution using a density plot.
```{r}
#create the ggplot and add density of question 2
ques2_density = ggplot(data = cleveland,aes(x = cleveland$`Pie ques 2`)) + geom_density(fill = "lightblue", adjust=2)
#add normal density with same mean and sd
ques2_density = ques2_density + stat_function(fun = dnorm, args = list(mean = mean(ques2), sd = sd(ques2)), colour = 'orangered2', size=1)
#add the lables of x,y
ques2_density = ques2_density + xlab("") + ylab("Density")
#draw the plot with title
ques2_density + ggtitle("Normal Density and Question 2 density")


```

c.After all the varoius checks we have made, we can assume that the distribution of question 2 is not-normal. This approximation is very important when we want to analyse the data and ask questions about it.

10. In a single figure, we can graph the boxplots for each experiment question.For that, we will use the base R function
stack. 

Now, let's use the Stack function, and check it's output:

```{r}
#create a stack of our data
clev_stack = stack(cleveland)
#give indicative names
colnames(clev_stack)[2] = c("question")
#peek our data
head(clev_stack)
```


We can see that now it will be really simple to create the boxplot for each experiment question. An interesting addition will be to add the true value of the shape that the experienced tried to guess. To do so, we join our name vector the correct values from correct_2019.

```{r}
#create a data frame
correct = as.data.frame(correct)
#add the questions name
correct = cbind(correct,names)
#give indicative name to the column
colnames(correct) = c("true_values", "question")
#peek our data
head(correct)
```


And now, let's create the plot.

```{r}
#create the boxplot
clev_stack_box = ggplot(data = clev_stack, aes(x=question, y=values)) + geom_boxplot()
#add some design, fonts and sizes
clev_stack_box = clev_stack_box + theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10), axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))
#add the true values
clev_stack_box = clev_stack_box + geom_point(data=correct, aes(x=question, y=true_values), col="red", size=3)
#show the plot with x,y and main title
clev_stack_box + labs(title="Experiment Questions Distribution", x="Question", y = "Value")
```

11. Now, an interesting question is, does the experienced answers average is match to the correct answer ?

To do so, first we can add an average column to the correct data.

```{r}
#add average column
correct = cbind(colMeans(cleveland), correct)
#give indicative name
colnames(correct)[1] = "avg"
correct
```

a. Now, let's draw a graph. We can compare the average graphically to the true values in the correct file, and Add a 45-degree line x = y. In addition, we can color by question type. Let's add the type to each question.
```{r}
correct$type[1:5] = "Pie"
correct$type[6:10] = "Line"
correct$type[11:15] = "Shade"
correct$type[16:20] = "Spot"


```

And now, we can finally draw our graph.


```{r}
#create the plot
avg_correct_plot = ggplot(correct , aes(x = true_values, y = avg, color=type)) + geom_point(size=3) + geom_abline(intercept = 0, slope = 1)
#add axis names and abline tag
avg_correct_plot = avg_correct_plot + labs(title = "True values and experiments guess",x = "true values", y ="average guess values") + annotate("text",x=50,y=47,label="f(x)=x",size=5, angle=35)
avg_correct_plot
```

We can see an interesting thing here. Most of the points on the graph are higher than the identity line we draw. It means that in most of the questions, the average guess was a bit higher than the true value. I wonder what it means about us as human beings.

b. But, the average is not always a good measure of a group value, because it tends to be effected from outliers. We can use the median instead, which is get effected less. For example, imagine we have the vector c(40,40,40,40,40,40,40), and we add another entry to this vector, 90. The vector's average will be higher, but the median will stay same.

So, let's draw the very same graph we did on the last question, now with median values.

```{r}
#create a median vector
clev_med = apply(cleveland, 2, FUN = median)
#add it to our correct data frame
correct = cbind(clev_med, correct)
#give an indicative name
colnames(correct)[1] = "median"
#create the plot
median_correct_plot = ggplot(correct , aes(x = true_values, y = median, color=type)) + geom_point(size=3) + geom_abline(intercept = 0, slope = 1)
#add axis names and abline tag
median_correct_plot = median_correct_plot + labs(title = "True values and experiments guess",x = "true values", y ="median of guess values") + annotate("text",x=50,y=47,label="f(x)=x",size=5, angle=35)
median_correct_plot


```

Now, we can see that we get a better prediction based on the values of the median, and not the average.
We still can see that the median of guesses was a bit higher than the true value.

